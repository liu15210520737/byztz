<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>不要做挑战</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin-top: 20px;
        }
        .card {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .chat-box {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">不要做挑战</h1>
        <div class="card">
            <h2>房间信息</h2>
            <div>
                <label for="roomName">房间号：</label>
                <input type="text" id="roomName" class="form-control" placeholder="输入房间号或创建房间">
            </div>
            <div class="mt-3">
                <label for="playerName">玩家名称：</label>
                <input type="text" id="playerName" class="form-control" placeholder="输入你的名字">
            </div>
            <div class="mt-3">
                <label for="numPlayers">房间人数：</label>
                <input type="number" id="numPlayers" class="form-control" value="4" min="2">
            </div>
            <div class="mt-3">
                <label for="numCards">牌数：</label>
                <input type="number" id="numCards" class="form-control" value="5" min="1">
            </div>
            <div class="mt-3">
                <button onclick="joinOrCreateRoom()" class="btn btn-primary">加入/创建房间</button>
            </div>
        </div>

        <div id="gameArea" style="display:none;">
            <div class="card">
                <h2>玩家列表</h2>
                <ul id="playerList" class="list-group"></ul>
            </div>
            <div class="card">
                <h2>聊天室</h2>
                <div id="chatBox" class="chat-box"></div>
                <input type="text" id="chatInput" class="form-control" placeholder="输入消息">
                <button onclick="sendMessage()" class="btn btn-primary mt-2">发送</button>
            </div>
            <div class="card">
                <h2>你的卡片</h2>
                <div id="playerCard" class="alert alert-warning"></div>
            </div>
        </div>
    </div>

    <script src="https://fastly.jsdelivr.net/npm/@upstash/redis@1.34.4"></script> <!-- 更新为指定的版本 -->
    <script>
        let redisClient;
        const upstashUrl = "https://inspired-ox-13540.upstash.io"; // 替换为你的Upstash URL
        const upstashToken = "ATTkAAIjcDFiMzcwNDZmNjZkZGE0NTA1OTRlZTgyODgxYTcyNzdlZnAxMA"; // 替换为你的Upstash Token

        async function connectRedis() {
            const { createClient } = UpstashRedis;
            redisClient = createClient({
                url: upstashUrl,
                token: upstashToken
            });
            try {
                await redisClient.connect();
            } catch (error) {
                console.error("Redis连接失败:", error);
                alert("无法连接到Redis，请检查设置。");
            }
        }

        async function joinOrCreateRoom() {
            const roomName = document.getElementById("roomName").value;
            const playerName = document.getElementById("playerName").value;
            const numPlayers = parseInt(document.getElementById("numPlayers").value);
            const numCards = parseInt(document.getElementById("numCards").value);

            if (!roomName || !playerName || isNaN(numPlayers) || isNaN(numCards)) {
                alert("请输入完整信息！");
                return;
            }

            await connectRedis();

            const roomKey = `room:${roomName}`;
            const playerKey = `${roomKey}:players`;
            const cardKey = `${roomKey}:cards`;

            // 加入房间或创建房间
            let players = await redisClient.hGetAll(playerKey);
            players = players || {}; // 确保players是一个对象
            players[playerName] = JSON.stringify({ name: playerName, card: null });
            await redisClient.hSet(playerKey, players);

            // 初始化卡片
            const cards = generateCards(numCards);
            await redisClient.hSet(cardKey, cards);

            document.getElementById("gameArea").style.display = "block";
            updatePlayerList(players);
            drawCard(playerName);
        }

        function generateCards(numCards) {
            const cardContents = [
                "不能笑",
                "不能说'不'",
                "不能摇头",
                "不能说'是'",
                "不能摸头",
                "不能眨眼",
                "不能说'我'"
            ];
            const cards = {};
            const usedCards = new Set(); // 用于跟踪已使用的卡片
            for (let i = 0; i < numCards; i++) {
                let content;
                do {
                    content = cardContents[Math.floor(Math.random() * cardContents.length)];
                } while (usedCards.has(content)); // 确保不重复
                usedCards.add(content);
                cards[`card${i}`] = content;
            }
            return cards;
        }

        function updatePlayerList(players) {
            const playerList = document.getElementById("playerList");
            playerList.innerHTML = "";
            for (const player in players) {
                const playerData = JSON.parse(players[player]);
                const listItem = document.createElement("li");
                listItem.classList.add("list-group-item");
                listItem.textContent = playerData.name;
                playerList.appendChild(listItem);
            }
        }

        async function drawCard(playerName) {
            const roomName = document.getElementById("roomName").value;
            const cardKey = `room:${roomName}:cards`;
            const playerKey = `room:${roomName}:players`;

            const cards = await redisClient.hGetAll(cardKey);
            const cardKeys = Object.keys(cards);
            const randomIndex = Math.floor(Math.random() * cardKeys.length);
            const cardContent = cards[cardKeys[randomIndex]];
            await redisClient.hSet(playerKey, playerName, JSON.stringify({ name: playerName, card: cardContent }));

            const playerCard = document.getElementById("playerCard");
            playerCard.textContent = `你的卡片：${cardContent}`;
        }

        async function sendMessage() {
            const roomName = document.getElementById("roomName").value;
            const playerName = document.getElementById("playerName").value;
            const chatInput = document.getElementById("chatInput");
            const message = chatInput.value.trim();

            if (!message) return;

            const chatKey = `room:${roomName}:chat`;
            const timestamp = Date.now();
            await redisClient.rPush(chatKey, JSON.stringify({ name: playerName, message, timestamp }));

            chatInput.value = "";
            loadChatMessages();
        }

        async function loadChatMessages() {
            const roomName = document.getElementById("roomName").value;
            const chatKey = `room:${roomName}:chat`;
            const chatBox = document.getElementById("chatBox");

            const messages = await redisClient.lRange(chatKey, 0, -1);
            chatBox.innerHTML = "";
            messages.forEach((msg) => {
                const messageData = JSON.parse(msg);
                const messageElement = document.createElement("div");
                messageElement.textContent = `${messageData.name}: ${messageData.message}`;
                chatBox.appendChild(messageElement);
            });
            chatBox.scrollTop = chatBox.scrollHeight; // 滚动到底部
        }

        document.getElementById("chatInput").addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                sendMessage();
            }
        });

        setInterval(loadChatMessages, 2000);
    </script>
</body>
</html>
